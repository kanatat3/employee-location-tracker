<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Employee Location Tracker (ปรับอินพุต & ออโต้คอมพรีท)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts (Sarabun) -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Sarabun', sans-serif;
      background-color: #EFF6FF; /* light blue-50 */
    }
    body {
      overflow-y: auto;
      padding: 1rem;
    }

    /* ---------- Map ---------- */
    #map {
      height: 300px;
      width: 100%;
      border: 1px solid #CBD5E1; /* gray-300 */
      border-radius: 0.5rem;      /* rounded-lg */
      overflow: hidden;
    }

    /* ------ Message Box ------ */
    #messageBox {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      padding: 0.75rem 1.25rem;
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-size: 1rem;
      font-weight: 500;
      display: none;
    }

    /* ---- Confirmation Modal ---- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      border-radius: 0.75rem; /* rounded-xl */
      padding: 1.5rem;       /* p-6 */
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    /* ==== De-emphasized Input Row (Shrunken) ==== */
    .deemphasized-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;              /* space between rows */
      border: 1px solid #CBD5E1;/* gray-300 */
      border-radius: 0.375rem;  /* rounded-md */
      background-color: #F8FAFC;/* gray-100 (very subtle) */
      padding: 0.5rem;         /* p-2 */
      margin-top: 1rem;         /* mt-4 */
    }
    .deemphasized-container .input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }
    .deemphasized-container label {
      font-size: 0.75rem;      /* text-xs */
      font-weight: 500;
      min-width: 60px;
      color: #4A5568;          /* gray-700 */
    }
    .deemphasized-container .search-wrapper {
      position: relative;
      flex: 1;
    }
    .deemphasized-container input {
      width: 100%;
      padding: 0.25rem 0.5rem;  /* py-1 px-2 */
      font-size: 0.75rem;      /* text-xs */
      border: 1px solid #CBD5E1;/* gray-300 */
      border-radius: 0.375rem; /* rounded-md */
      outline: none;
    }
    .deemphasized-container .clear-icon {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: #A0AEC0; /* gray-400 */
      cursor: pointer;
      display: none;
      font-size: 0.875rem;
    }
    .deemphasized-container button {
      display: flex;
      align-items: center;
      gap: 0.25rem;             /* small gap between icon + text */
      padding: 0.25rem 0.5rem;  /* py-1 px-2 */
      font-size: 0.75rem;      /* text-xs */
      font-weight: 600;
      border-radius: 0.375rem; /* rounded-md */
      border: none;
      transition: transform 0.15s ease-in-out;
    }
    .deemphasized-container button:hover {
      transform: scale(1.02);
    }
    /* “ค้นหา” button */
    .btn-search {
      background-color: #2D3748; /* gray-800 */
      color: white;
    }
    .btn-search:hover {
      background-color: #1A202C; /* gray-900 */
    }
    /* “ตำแหน่งปัจจุบัน” moved button */
    .btn-current-small {
      background-color: #805AD5; /* purple-600 */
      color: white;
      font-size: 0.75rem;        /* text-xs */
      padding: 0.25rem 0.5rem;   /* py-1 px-2 */
      border-radius: 0.375rem;   /* rounded-md */
      display: flex;
      align-items: center;
      gap: 0.25rem;
      border: none;
      transition: transform 0.15s ease-in-out;
    }
    .btn-current-small:hover {
      background-color: #6B46C1; /* purple-700 */
    }

    /* ---- Autocomplete List ---- */
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #CBD5E1; /* gray-300 */
      border-top: none;
      z-index: 50;
      max-height: 150px;
      overflow-y: auto;
      border-bottom-left-radius: 0.375rem;
      border-bottom-right-radius: 0.375rem;
    }
    .autocomplete-item {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;       /* text-xs */
      color: #4A5568;           /* gray-700 */
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background-color: #EDF2F7; /* gray-100 */
    }

    /* -------- Action Buttons (Bottom Row) -------- */
    .action-row {
      background-color: white;
      border: 1px solid #E2E8F0; /* gray-200 */
      border-radius: 0.5rem;     /* rounded-lg */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0.5rem;          /* reduced padding */
      margin-top: 1rem;          /* mt-4 */
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;              /* reduced gap */
      justify-content: center;
    }
    .action-row button {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;  /* reduced size */
      font-size: 0.75rem;       /* text-xs */
      border-radius: 0.375rem;   /* rounded-md */
      transition: transform 0.15s ease-in-out;
      border: none;
    }
    .action-row button:hover {
      transform: scale(1.02);
    }
    .bg-save {
      background-color: #38A169; /* green-500 */
      color: white;
    }
    .bg-save:hover {
      background-color: #2F855A; /* green-600 */
    }
    .bg-export {
      background-color: #3182CE; /* blue-500 */
      color: white;
    }
    .bg-export:hover {
      background-color: #2B6CB0; /* blue-600 */
    }
    .bg-back {
      background-color: #2D3748; /* gray-800 */
      color: white;
    }
    .bg-back:hover {
      background-color: #1A202C; /* gray-900 */
    }

    /* ---- Saved Locations Table + “Clear All” at top-right ---- */
    .table-container {
      position: relative;
      margin-top: 1rem;          /* mt-4 */
      border: 1px solid #CBD5E1; /* gray-300 */
      border-radius: 0.5rem;     /* rounded-lg */
      background-color: white;
      overflow: hidden;
    }
    .table-container h4 {
      margin: 0;
      padding: 0.75rem 1rem;
      background-color: #F7FAFC; /* gray-100 */
      font-size: 1rem;
      font-weight: 600;
      border-bottom: 1px solid #E2E8F0;
    }
    .btn-clear-top {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background-color: #E53E3E; /* red-500 */
      color: white;
      font-size: 0.75rem;       /* text-xs */
      font-weight: 600;
      padding: 0.25rem 0.5rem;  /* smaller */
      border: none;
      border-radius: 0.375rem; /* rounded-md */
      transition: transform 0.15s ease-in-out;
      z-index: 10;
    }
    .btn-clear-top:hover {
      background-color: #C53030; /* red-600 */
      transform: scale(1.02);
    }
    .table-scroll {
      max-height: 240px;       /* fixed height for the body */
      overflow-y: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 0.5rem 0.75rem;  /* py-2 px-3 */
      font-size: 0.875rem;      /* text-sm */
      color: #4A5568;           /* gray-700 */
      border-bottom: 1px solid #E2E8F0; /* gray-200 */
    }
    th {
      background-color: #F7FAFC; /* gray-100 */
      font-weight: 600;
    }
    .hidden-col {
      display: none;
    }

    @media (min-width: 640px) {
      .deemphasized-container {
        padding: 0.5rem;  /* p-2 */
      }
      .action-row {
        padding: 0.75rem;    /* slightly larger on desktop */
      }
      .btn-clear-top {
        top: 1rem;
        right: 1.25rem;
      }
      .table-scroll {
        max-height: 300px;
      }
    }
  </style>
</head>

<body>
  <div class="mx-auto max-w-md bg-white rounded-xl shadow-lg p-6 space-y-4">
    <h3 class="text-2xl font-semibold text-gray-800 text-center">Location Tracker</h3>

    <!-- Map -->
    <div id="map"></div>

    <!-- Lat / Lng display + Current Location button -->
    <div class="flex justify-center items-center gap-4 text-xs font-medium text-gray-700 mt-2">
      <p>Latitude: <span id="lat" class="font-bold text-blue-600">--</span></p>
      <p>Longitude: <span id="lng" class="font-bold text-blue-600">--</span></p>
      <button id="currentLocationButton" class="btn-current-small">
        <i class="fas fa-map-marker-alt"></i>
        <span>ตำแหน่งปัจจุบัน</span>
      </button>
    </div>

    <!-- ==== De-emphasized Input Row (Shrunken) ==== -->
    <div class="deemphasized-container">
      <!-- Row 1: ID พนักงาน -->
      <div class="input-row">
        <label for="employeeIdInput">ID พนักงาน</label>
        <input
          id="employeeIdInput"
          type="text"
          placeholder="เช่น 824001"
        />
      </div>
      <!-- Row 2: ค้นหา + ปุ่มค้นหา -->
      <div class="input-row">
        <label for="locationSearchInput">ค้นหา</label>
        <div class="search-wrapper">
          <input
            id="locationSearchInput"
            type="text"
            placeholder="เช่น กรุงเทพฯ"
            autocomplete="off"
          />
          <i id="clearSearchIcon" class="fas fa-times clear-icon"></i>
          <div id="autocompleteList" class="autocomplete-list hidden"></div>
        </div>
        <button id="searchLocationButton" class="btn-search">
          <i class="fas fa-search"></i>
          <span>ค้นหา</span>
        </button>
      </div>
    </div>

    <!-- ===== Action Buttons (Bottom Row) ===== -->
    <div class="action-row">
      <button id="saveButton" class="bg-save">
        <i class="fas fa-save"></i>
        <span>Save</span>
      </button>
      <button id="exportCsvButton" class="bg-export">
        <i class="fas fa-file-export"></i>
        <span>Export</span>
      </button>
      <button id="backButton" class="bg-back">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <!-- Hidden Edit Buttons (only when editing) -->
    <div id="editActionButtons" class="hidden flex justify-center gap-4">
      <button id="confirmEditButton" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-md shadow">
        <i class="fas fa-check"></i>
        <span>Save Edit</span>
      </button>
      <button id="cancelEditButton" class="flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded-md shadow">
        <i class="fas fa-times"></i>
        <span>Cancel</span>
      </button>
    </div>

    <!-- Message Box -->
    <div id="messageBox"></div>

    <!-- ===== Saved Locations Table + Clear All top-right ===== -->
    <div class="table-container">
      <!-- Table header with title -->
      <h4>ตำแหน่งที่บันทึกไว้</h4>

      <!-- “Clear All” at top-right -->
      <button id="clearAllButton" class="btn-clear-top">
        <i class="fas fa-trash-alt"></i>
        <span>Clear All</span>
      </button>

      <!-- Scrollable table body -->
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th class="text-left">ID</th>
              <th class="text-left">ID พนักงาน</th>
              <th class="hidden-col">Latitude</th>
              <th class="hidden-col">Longitude</th>
              <th class="text-left">Timestamp</th>
              <th class="text-left">Google Maps</th>
              <th class="text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="savedLocationsTableBody">
            <tr class="text-center">
              <td colspan="7" class="py-4 px-4 text-gray-500">ยังไม่มีตำแหน่งที่บันทึกไว้</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
      <h4 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">ยืนยันการลบข้อมูล</h4>
      <p id="modalMessage" class="text-gray-700 mb-6">
        คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลนี้?<br>
        การดำเนินการนี้ไม่สามารถย้อนกลับได้
      </p>
      <div class="flex justify-center gap-4">
        <button id="confirmClearButton" class="bg-red-500 hover:bg-red-600 text-white font-bold text-xs py-2 px-4 rounded-lg shadow">
          ยืนยัน
        </button>
        <button id="cancelClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold text-xs py-2 px-4 rounded-lg shadow">
          ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /* -------------- Global Variables -------------- */
    let map;
    let currentMarker = null;
    let permanentMarkers = L.layerGroup();
    let permanentMarkersMap = {};
    let currentLat = null;
    let currentLng = null;
    let savedLocations = [];
    let nextId = 1;
    let editingId = null;
    let editingMarker = null;
    let undoStack = [];

    let actionType = null;         // 'clearAll' or 'deleteSingle'
    let pendingDeleteIndex = null;

    /* ------------ DOM References ------------ */
    const messageBox              = document.getElementById('messageBox');
    const savedLocationsTableBody = document.getElementById('savedLocationsTableBody');
    const employeeIdInput         = document.getElementById('employeeIdInput');
    const locationSearchInput     = document.getElementById('locationSearchInput');
    const clearSearchIcon         = document.getElementById('clearSearchIcon');
    const autocompleteList        = document.getElementById('autocompleteList');
    const confirmationModal       = document.getElementById('confirmationModal');
    const modalTitle              = document.getElementById('modalTitle');
    const modalMessage            = document.getElementById('modalMessage');
    const confirmClearButton      = document.getElementById('confirmClearButton');
    const cancelClearButton       = document.getElementById('cancelClearButton');
    const confirmEditButton       = document.getElementById('confirmEditButton');
    const cancelEditButton        = document.getElementById('cancelEditButton');
    const editActionButtonsDiv    = document.getElementById('editActionButtons');
    const normalActionButtonsDiv  = document.querySelector('.action-row');

    const searchLocationButton    = document.getElementById('searchLocationButton');
    const currentLocationButton   = document.getElementById('currentLocationButton');
    const saveButton              = document.getElementById('saveButton');
    const clearAllButton          = document.getElementById('clearAllButton');
    const exportCsvButton         = document.getElementById('exportCsvButton');
    const backButton              = document.getElementById('backButton');

    /* ---------- Custom Leaflet Icons ---------- */
    const redIcon = new L.Icon({
      iconUrl:    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      shadowUrl:  'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize:   [25, 41],
      iconAnchor: [12, 41],
      popupAnchor:[1, -34],
      shadowSize: [41, 41]
    });
    const blueIcon = new L.Icon({
      iconUrl:    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl:  'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize:   [25, 41],
      iconAnchor: [12, 41],
      popupAnchor:[1, -34],
      shadowSize: [41, 41]
    });
    const yellowIcon = new L.Icon({
      iconUrl:    'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl:  'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize:   [25, 41],
      iconAnchor: [12, 41],
      popupAnchor:[1, -34],
      shadowSize: [41, 41]
    });

    /* ---------- Helper: Show Message ---------- */
    function showMessage(msg, type = 'info') {
      messageBox.textContent = msg;
      messageBox.className = '';
      messageBox.style.display = 'flex';
      if (type === 'success') {
        messageBox.classList.add('bg-green-100', 'text-green-800');
      } else if (type === 'error') {
        messageBox.classList.add('bg-red-100', 'text-red-800');
      } else if (type === 'warning') {
        messageBox.classList.add('bg-yellow-100', 'text-yellow-800');
      } else {
        messageBox.classList.add('bg-blue-100', 'text-blue-800');
      }
      setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
    }

    /* ------ Show / Hide Confirmation Modal ------ */
    function showConfirmation() {
      confirmationModal.style.display = 'flex';
    }
    function hideConfirmation() {
      confirmationModal.style.display = 'none';
      modalTitle.textContent = 'ยืนยันการลบข้อมูล';
      modalMessage.innerHTML = 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลนี้?<br>การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      confirmClearButton.textContent = 'ยืนยัน';
    }

    /* ---- Update / Hide Current Marker ---- */
    function updateCurrentMarker(lat, lng, isDraggable = false) {
      if (!currentMarker) {
        currentMarker = L.marker([lat, lng], { icon: redIcon, draggable: isDraggable }).addTo(map);
        currentMarker.on('dragend', (e) => {
          const newPos = e.target.getLatLng();
          currentLat = newPos.lat; currentLng = newPos.lng;
          document.getElementById('lat').textContent = currentLat.toFixed(6);
          document.getElementById('lng').textContent = currentLng.toFixed(6);
        });
      } else {
        currentMarker.setLatLng([lat, lng]);
        currentMarker.options.draggable = isDraggable;
        if (currentMarker._icon) {
          if (isDraggable) L.DomUtil.addClass(currentMarker._icon, 'leaflet-marker-draggable');
          else L.DomUtil.removeClass(currentMarker._icon, 'leaflet-marker-draggable');
        }
        currentMarker.addTo(map);
      }
      currentLat = lat; currentLng = lng;
      document.getElementById('lat').textContent = lat.toFixed(6);
      document.getElementById('lng').textContent = lng.toFixed(6);
    }
    function hideCurrentMarker() {
      if (currentMarker && map.hasLayer(currentMarker)) map.removeLayer(currentMarker);
      currentLat = null; currentLng = null;
      document.getElementById('lat').textContent = '--';
      document.getElementById('lng').textContent = '--';
    }

    /* ---- Render Permanent Markers ---- */
    function renderPermanentMarkers() {
      permanentMarkers.clearLayers();
      permanentMarkersMap = {};

      savedLocations.forEach((loc) => {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        const marker = L.marker([loc.lat, loc.lng], { icon: blueIcon })
          .addTo(permanentMarkers)
          .bindPopup(`
            <b>ID:</b> ${loc.id}<br>
            <b>ID พนักงาน:</b> ${loc.name}<br>
            <div style="margin-top:8px;display:flex;gap:4px;">
              <a href="${googleMapsUrl}" target="_blank"
                 style="background-color:#4285F4;color:#fff;padding:4px 8px;border-radius:4px;text-decoration:none;font-size:0.875rem;">
                ดูบน Google Maps
              </a>
              <button class="edit-pin-btn" data-id="${loc.id}"
                      style="background-color:#FFC107;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:0.875rem;">
                Edit
              </button>
              <button class="delete-btn" data-id="${loc.id}"
                      style="background-color:#EF4444;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:0.875rem;">
                X
              </button>
            </div>
          `);
        permanentMarkersMap[loc.id] = marker;

        marker.on('popupopen', () => {
          const popupContent = marker.getPopup().getContent();
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = popupContent;

          const deleteBtn = tempDiv.querySelector('.delete-btn');
          if (deleteBtn) {
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              deleteLocation(parseInt(deleteBtn.dataset.id));
              map.closePopup();
            };
          }
          const editBtn = tempDiv.querySelector('.edit-pin-btn');
          if (editBtn) {
            editBtn.onclick = (e) => {
              e.stopPropagation();
              map.closePopup();
              editLocation(parseInt(editBtn.dataset.id));
            };
          }
          marker.getPopup().setContent(tempDiv);
        });
      });

      permanentMarkers.addTo(map);
    }

    /* ---- Render Saved Locations Table ---- */
    function renderTable() {
      savedLocationsTableBody.innerHTML = '';
      if (savedLocations.length === 0) {
        const noRow = document.createElement('tr');
        noRow.innerHTML = `
          <td colspan="7" class="py-4 px-4 text-gray-500 text-center">ยังไม่มีตำแหน่งที่บันทึกไว้</td>
        `;
        savedLocationsTableBody.appendChild(noRow);
        return;
      }

      savedLocations.forEach((loc) => {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${loc.id}</td>
          <td>${loc.name}</td>
          <td class="hidden-col">${loc.lat.toFixed(6)}</td>
          <td class="hidden-col">${loc.lng.toFixed(6)}</td>
          <td>${loc.timestamp}</td>
          <td>
            <a href="${googleMapsUrl}" target="_blank" class="text-blue-600 hover:underline text-sm">
              ดูบน Google Maps
            </a>
          </td>
          <td class="space-x-2">
            <button onclick="editLocation(${loc.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-md text-sm">
              Edit
            </button>
            <button onclick="deleteLocation(${loc.id})" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md text-sm">
              X
            </button>
          </td>
        `;
        savedLocationsTableBody.appendChild(row);
      });
    }

    /* ---- Save New Location (or Edit) ---- */
    function saveLocation() {
      undoStack.push(JSON.stringify(savedLocations));
      if (editingId !== null) {
        confirmEditButton.click();
        return;
      }
      if (currentLat === null || currentLng === null) {
        showMessage('กรุณาคลิกบนแผนที่หรือค้นหาสถานที่ก่อนบันทึก!', 'warning');
        return;
      }
      let empId = employeeIdInput.value.trim();
      if (empId === '') {
        empId = `ID พนักงานที่ ${nextId}`;
      }
      const newLocation = {
        id: nextId,
        name: empId,
        lat: currentLat,
        lng: currentLng,
        timestamp: new Date().toLocaleString('th-TH')
      };
      savedLocations.push(newLocation);
      nextId++;
      showMessage('บันทึกตำแหน่งใหม่เรียบร้อย!', 'success');
      localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
      localStorage.setItem('nextId', nextId.toString());

      employeeIdInput.value = '';
      hideCurrentMarker();
      renderPermanentMarkers();
      renderTable();
    }

    /* ---- Load from localStorage ---- */
    function loadLocations() {
      const stored = localStorage.getItem('allSavedLocations');
      const storedNext = localStorage.getItem('nextId');
      if (stored) {
        savedLocations = JSON.parse(stored);
        let maxId = 0;
        savedLocations.forEach((loc) => {
          if (loc.id && loc.id > maxId) maxId = loc.id;
        });
        nextId = storedNext ? parseInt(storedNext) : maxId + 1;
        showMessage('โหลดตำแหน่งที่บันทึกไว้แล้ว!', 'info');
      } else {
        savedLocations = [];
        showMessage('ไม่พบตำแหน่งที่บันทึกไว้', 'info');
        nextId = 1;
      }
      renderPermanentMarkers();
      renderTable();
    }

    /* ---- Delete Single Location (confirm) ---- */
    function deleteLocation(id) {
      undoStack.push(JSON.stringify(savedLocations));
      const idx = savedLocations.findIndex((l) => l.id === id);
      if (idx === -1) {
        showMessage('ไม่พบรายการที่จะลบ', 'error');
        return;
      }
      actionType = 'deleteSingle';
      pendingDeleteIndex = idx;
      const locToDelete = savedLocations[idx];
      modalTitle.textContent = 'ยืนยันการลบตำแหน่ง';
      modalMessage.innerHTML = `คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่ง <b>ID: ${locToDelete.id}</b> (พนักงาน: ${locToDelete.name})?<br>การดำเนินการนี้ไม่สามารถย้อนกลับได้`;
      confirmClearButton.textContent = 'ยืนยันการลบ';
      showConfirmation();
    }

    /* ---- Request Clear All (confirm) ---- */
    function requestClearAll() {
      actionType = 'clearAll';
      modalTitle.textContent = 'ยืนยันการลบข้อมูลทั้งหมด';
      modalMessage.innerHTML = 'คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่งที่บันทึกไว้ทั้งหมด?<br>การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      confirmClearButton.textContent = 'ยืนยันการล้างทั้งหมด';
      showConfirmation();
    }
    function performClearAll() {
      undoStack.push(JSON.stringify(savedLocations));
      localStorage.removeItem('allSavedLocations');
      localStorage.removeItem('nextId');
      savedLocations = [];
      nextId = 1;
      hideCurrentMarker();
      if (editingMarker) map.removeLayer(editingMarker);
      editingMarker = null;
      editingId = null;
      employeeIdInput.value = '';
      locationSearchInput.value = '';
      hideAutocomplete();
      map.setView([13.7563, 100.5018], 6);
      showMessage('ตำแหน่งที่บันทึกไว้ทั้งหมดถูกลบแล้ว!', 'success');
      renderPermanentMarkers();
      renderTable();
      hideConfirmation();
      document.getElementById('editActionButtons').classList.add('hidden');
      normalActionButtonsDiv.classList.remove('hidden');
    }

    /* ---- Export to CSV ---- */
    function csvEscape(value) {
      if (value == null) return '';
      let str = String(value);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }
    function exportToCSV() {
      if (savedLocations.length === 0) {
        showMessage('ไม่มีข้อมูลที่จะ Export!', 'warning');
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "ID,ID พนักงาน,Latitude,Longitude,Timestamp,Google Maps\n";
      savedLocations.forEach((loc) => {
        const gmaps = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        const row = [
          csvEscape(loc.id),
          csvEscape(loc.name),
          csvEscape(loc.lat.toFixed(6)),
          csvEscape(loc.lng.toFixed(6)),
          csvEscape(loc.timestamp),
          csvEscape(gmaps)
        ].join(',');
        csvContent += row + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "saved_employee_locations.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showMessage('Export ข้อมูลเป็น CSV เรียบร้อยแล้ว!', 'success');
    }

    /* ---- Get Current Location ---- */
    function getCurrentLocation() {
      if (editingId !== null) cancelEditButton.click();
      if (navigator.geolocation) {
        showMessage('กำลังค้นหาตำแหน่งปัจจุบัน...', 'info');
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = parseFloat(position.coords.latitude);
            const lng = parseFloat(position.coords.longitude);
            updateCurrentMarker(lat, lng, false);
            map.setView([lat, lng], 15);
            showMessage('พบตำแหน่งปัจจุบันแล้ว!', 'success');
          },
          (error) => {
            let errMsg = '';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errMsg = 'ไม่อนุญาตให้เข้าถึงตำแหน่ง';
                break;
              case error.POSITION_UNAVAILABLE:
                errMsg = 'ไม่สามารถระบุตำแหน่งได้';
                break;
              case error.TIMEOUT:
                errMsg = 'หมดเวลาในการค้นหาตำแหน่ง';
                break;
              default:
                errMsg = `เกิดข้อผิดพลาด: ${error.message}`;
            }
            showMessage(`ไม่สามารถระบุตำแหน่งปัจจุบันได้: ${errMsg}`, 'error');
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      } else {
        showMessage('เบราว์เซอร์ของคุณไม่รองรับ Geolocation.', 'error');
      }
    }

    /* ---- Autocomplete Helpers ---- */
    let autocompleteTimeout = null;
    function showAutocomplete(items) {
      autocompleteList.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        hideAutocomplete();
        return;
      }
      items.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('autocomplete-item');
        div.textContent = item.display_name;
        div.dataset.lat = item.lat;
        div.dataset.lon = item.lon;
        div.addEventListener('click', () => {
          const lat = parseFloat(div.dataset.lat);
          const lon = parseFloat(div.dataset.lon);
          updateCurrentMarker(lat, lon, false);
          map.setView([lat, lon], 13);
          showMessage(`เลือกสถานที่: ${item.display_name}`, 'success');
          locationSearchInput.value = item.display_name;
          hideAutocomplete();
        });
        autocompleteList.appendChild(div);
      });
      autocompleteList.classList.remove('hidden');
    }
    function hideAutocomplete() {
      autocompleteList.classList.add('hidden');
      autocompleteList.innerHTML = '';
    }

    /* ---- Search Location via Nominatim for Autocomplete ---- */
    function fetchAutocomplete(query) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
        .then(res => res.json())
        .then(data => {
          showAutocomplete(data);
        })
        .catch(err => {
          console.error('Error fetching autocomplete:', err);
        });
    }

    /* ---- Search Location on Button/Enter ---- */
    function searchLocation(query) {
      if (!query.trim()) return;
      if (editingId !== null) cancelEditButton.click();
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data) && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            updateCurrentMarker(lat, lon, false);
            map.setView([lat, lon], 13);
            showMessage(`เลือกสถานที่: ${data[0].display_name}`, 'success');
            locationSearchInput.value = data[0].display_name;
          } else {
            showMessage('ไม่พบตำแหน่งที่ค้นหา', 'warning');
          }
        })
        .catch(err => {
          console.error('Error searching location:', err);
          showMessage('เกิดข้อผิดพลาดในการค้นหา', 'error');
        });
    }

    /* ---- Edit Location ---- */
    function editLocation(id) {
      const loc = savedLocations.find((l) => l.id === id);
      if (!loc) return;
      if (editingId !== null && editingId !== id) cancelEditButton.click();

      editingId = id;
      if (permanentMarkersMap[loc.id]) {
        permanentMarkers.removeLayer(permanentMarkersMap[loc.id]);
        delete permanentMarkersMap[loc.id];
      }

      if (!editingMarker) {
        editingMarker = L.marker([loc.lat, loc.lng], { icon: yellowIcon, draggable: true }).addTo(map);
        editingMarker.on('drag', (e) => {
          const pos = e.target.getLatLng();
          currentLat = pos.lat; currentLng = pos.lng;
          document.getElementById('lat').textContent = currentLat.toFixed(6);
          document.getElementById('lng').textContent = currentLng.toFixed(6);
        });
      } else {
        editingMarker.setLatLng([loc.lat, loc.lng]);
        editingMarker.options.draggable = true;
        if (editingMarker._icon) L.DomUtil.addClass(editingMarker._icon, 'leaflet-marker-draggable');
        editingMarker.addTo(map);
      }

      map.setView([loc.lat, loc.lng], map.getZoom() || 14);
      employeeIdInput.value = loc.name;
      document.getElementById('lat').textContent = loc.lat.toFixed(6);
      document.getElementById('lng').textContent = loc.lng.toFixed(6);
      currentLat = loc.lat; currentLng = loc.lng;

      editActionButtonsDiv.classList.remove('hidden');
      normalActionButtonsDiv.classList.add('hidden');
      showMessage(`กำลังแก้ไขตำแหน่ง ID: ${id}`, 'info');
    }

    /* ---- Confirm Edit ---- */
    confirmEditButton.addEventListener('click', () => {
      undoStack.push(JSON.stringify(savedLocations));
      if (editingId === null || currentLat === null || currentLng === null) {
        showMessage('ไม่มีการแก้ไขที่กำลังดำเนินการ หรือข้อมูลไม่สมบูรณ์', 'warning');
        return;
      }
      const idx = savedLocations.findIndex((l) => l.id === editingId);
      if (idx === -1) {
        showMessage('ไม่พบตำแหน่งที่จะอัปเดต', 'error');
        cancelEditButton.click();
        return;
      }
      const newEmpId = employeeIdInput.value.trim();
      if (newEmpId === '') {
        showMessage('ID พนักงานไม่สามารถเว้นว่างได้', 'error');
        return;
      }
      if (isNaN(currentLat) || currentLat < -90 || currentLat > 90 || isNaN(currentLng) || currentLng < -180 || currentLng > 180) {
        showMessage('ค่าละติจูดและลองจิจูดไม่ถูกต้อง กรุณาแก้ไขให้ถูกต้อง', 'error');
        return;
      }
      savedLocations[idx].lat       = currentLat;
      savedLocations[idx].lng       = currentLng;
      savedLocations[idx].name      = newEmpId;
      savedLocations[idx].timestamp = new Date().toLocaleString('th-TH');
      localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
      showMessage('อัปเดตตำแหน่งแล้ว!', 'success');

      editingId = null;
      if (editingMarker) map.removeLayer(editingMarker);
      editingMarker = null;
      currentLat = null; currentLng = null;
      document.getElementById('lat').textContent = '--';
      document.getElementById('lng').textContent = '--';
      employeeIdInput.value = '';
      document.getElementById('editActionButtons').classList.add('hidden');
      normalActionButtonsDiv.classList.remove('hidden');

      renderPermanentMarkers();
      renderTable();
    });

    /* ---- Cancel Edit ---- */
    cancelEditButton.addEventListener('click', () => {
      if (editingMarker) map.removeLayer(editingMarker);
      editingMarker = null;
      editingId = null;
      currentLat = null; currentLng = null;
      document.getElementById('lat').textContent = '--';
      document.getElementById('lng').textContent = '--';
      employeeIdInput.value = '';
      document.getElementById('editActionButtons').classList.add('hidden');
      normalActionButtonsDiv.classList.remove('hidden');
      showMessage('ยกเลิกการดำเนินการแล้ว', 'info');
      renderPermanentMarkers();
    });

    /* ---- Undo Last Action ---- */
    function undoLastAction() {
      if (undoStack.length === 0) {
        showMessage('ไม่พบการเปลี่ยนแปลงก่อนหน้า', 'warning');
        return;
      }
      if (editingId !== null) cancelEditButton.click();
      const lastState = undoStack.pop();
      if (lastState) {
        savedLocations = JSON.parse(lastState);
        localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
        renderPermanentMarkers();
        renderTable();
        showMessage('ย้อนกลับการเปลี่ยนแปลงแล้ว', 'success');
      }
    }

    /* ---- Initialize Map + Events ---- */
    window.onload = function() {
      map = L.map('map').setView([13.7563, 100.5018], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      permanentMarkers.addTo(map);

      map.on('click', (e) => {
        const lat = parseFloat(e.latlng.lat);
        const lng = parseFloat(e.latlng.lng);
        if (editingId !== null) {
          if (editingMarker) {
            editingMarker.setLatLng([lat, lng]);
          } else {
            editingMarker = L.marker([lat, lng], { icon: yellowIcon, draggable: true }).addTo(map);
            editingMarker.on('drag', (dragE) => {
              const pos = dragE.target.getLatLng();
              currentLat = pos.lat; currentLng = pos.lng;
              document.getElementById('lat').textContent = currentLat.toFixed(6);
              document.getElementById('lng').textContent = currentLng.toFixed(6);
            });
          }
          currentLat = lat; currentLng = lng;
          document.getElementById('lat').textContent = lat.toFixed(6);
          document.getElementById('lng').textContent = lng.toFixed(6);
        } else {
          updateCurrentMarker(lat, lng, false);
        }
      });

      /*  Autocomplete on input */
      locationSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query.length > 0) {
          clearSearchIcon.style.display = 'block';
          clearTimeout(autocompleteTimeout);
          autocompleteTimeout = setTimeout(() => {
            fetchAutocomplete(query);
          }, 400);
        } else {
          clearSearchIcon.style.display = 'none';
          hideAutocomplete();
        }
      });

      /* Clear icon click */
      clearSearchIcon.addEventListener('click', () => {
        locationSearchInput.value = '';
        clearSearchIcon.style.display = 'none';
        hideAutocomplete();
        locationSearchInput.focus();
      });

      /* Hide autocomplete on click outside */
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-wrapper')) {
          hideAutocomplete();
        }
      });

      /* Enter key triggers search */
      locationSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          hideAutocomplete();
          searchLocation(locationSearchInput.value);
        }
      });
      searchLocationButton.addEventListener('click', () => {
        hideAutocomplete();
        searchLocation(locationSearchInput.value);
      });
      currentLocationButton.addEventListener('click', () => {
        hideAutocomplete();
        getCurrentLocation();
      });

      saveButton.addEventListener('click', saveLocation);
      clearAllButton.addEventListener('click', requestClearAll);
      exportCsvButton.addEventListener('click', exportToCSV);
      backButton.addEventListener('click', undoLastAction);

      confirmClearButton.addEventListener('click', () => {
        if (actionType === 'clearAll') {
          performClearAll();
        } else if (actionType === 'deleteSingle') {
          if (pendingDeleteIndex !== null && savedLocations[pendingDeleteIndex]) {
            undoStack.push(JSON.stringify(savedLocations));
            const deleted = savedLocations.splice(pendingDeleteIndex, 1);
            localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
            showMessage(`ลบตำแหน่ง (ID: ${deleted[0].id}, ID พนักงาน: ${deleted[0].name}) แล้ว!`, 'success');
            renderPermanentMarkers();
            renderTable();
            if (editingId === deleted[0].id) cancelEditButton.click();
          }
        }
        actionType = null;
        pendingDeleteIndex = null;
        hideConfirmation();
      });
      cancelClearButton.addEventListener('click', () => {
        actionType = null;
        pendingDeleteIndex = null;
        hideConfirmation();
        showMessage('ยกเลิกการดำเนินการแล้ว', 'info');
      });

      loadLocations();
      map.invalidateSize();
    };

    window.addEventListener('resize', () => {
      if (map) map.invalidateSize();
    });
  </script>
</body>
</html>
