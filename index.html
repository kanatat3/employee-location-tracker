<!DOCTYPE html>
<html lang="en">
<head>
  <title>Map Click to Save Lat/Lng</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS for map styling -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Tailwind CSS for modern, responsive utility styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Sarabun for a clean look -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons (e.g., back arrow) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* Ensure the body and html take full height for proper layout */
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Sarabun', sans-serif;
      overflow-x: hidden; /* Prevent horizontal scrolling */
      scroll-behavior: smooth; /* Smooth scrolling for HTML */
    }
    /* Main container should allow scrolling if content overflows */
    body {
      height: 100vh; /* Set body height to 100% of viewport height */
      overflow-y: auto; /* Allow vertical scrolling for the body */
    }
    /* Map container fixed height */
    #map {
      height: 400px;
      width: 100%;
      /* Removed sticky, top, z-index as it's now handled by #stickyHeader */
      /* Removed flex-shrink: 0 as it's not directly a flex item in the new sticky context */
    }
    /* Styles for the confirmation modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    /* Styling for cells (no longer editable directly, only via input field) */
    td {
      padding: 0.25rem 0.5rem;
    }
    /* Sticky header for map and controls */
    #stickyHeader {
      position: sticky;
      top: 0;
      z-index: 999; /* Higher z-index to stay on top */
      background-color: white;
      padding: 16px 24px;
      border-bottom: 1px solid #ddd;
      /* Inherit main container's shadow/rounded corners if desired, or add here */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* light shadow */
      border-radius: 0.75rem; /* rounded-xl for consistency with main container */
      margin: -24px -24px 24px -24px; /* Counter main container's padding */
      width: calc(100% + 48px); /* Adjust width to fit parent with negative margins */
    }
    /* Adjust top-4 left-4 for back button relative to the outermost container */
    #backButton {
      top: 24px; /* Adjusted to match top padding of stickyHeader */
      left: 24px; /* Adjusted to match left padding of stickyHeader */
      z-index: 1000; /* Ensure back button is above stickyHeader */
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-blue-50 p-4">
  <div class="relative flex flex-col items-center justify-center w-full max-w-4xl bg-white shadow-lg rounded-xl p-6 space-y-4 mb-8">
    
    <!-- Sticky Header containing Map and Controls -->
    <div id="stickyHeader">
        <!-- Back Button Icon (position relative to the outer .relative container) -->
        <button id="backButton" class="absolute bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75" title="ย้อนกลับ">
          <i class="fas fa-arrow-left"></i>
        </button>

        <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">คลิกบนแผนที่เพื่อระบุละติจูดและลองจิจูด</h3>
        <!-- Map container -->
        <div id="map" class="rounded-lg border border-gray-300 overflow-hidden"></div>
        
        <!-- Panel Controls -->
        <div id="topControlSection" class="w-full max-h-[300px] overflow-y-auto pt-4"> <!-- Added pt-4 for spacing -->
            <!-- Search Input for Location Name -->
            <div class="w-full flex flex-col sm:flex-row items-center sm:space-x-4 mt-4">
              <label for="locationSearchInput" class="text-gray-700 text-lg font-medium sm:w-1/4">ค้นหาสถานที่:</label>
              <input type="text" id="locationSearchInput" placeholder="เช่น กรุงเทพมหานคร, สุวรรณภูมิ" 
                    class="mt-1 sm:mt-0 flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm text-gray-800">
              <button id="searchLocationButton" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mt-2 sm:mt-0">
                ค้นหาสถานที่
              </button>
            </div>
            <!-- New div for search results -->
            <div id="searchResultsContainer" class="w-full mt-2 hidden bg-white border border-gray-300 rounded-md shadow-md max-h-60 overflow-y-auto">
              <!-- Search results will be appended here -->
            </div>

            <!-- Latitude and Longitude display for current click -->
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-8 mt-4 text-lg font-medium text-gray-700 w-full flex-wrap">
              <p>ละติจูดที่เลือก: <span id="lat" class="font-bold text-blue-600">--</span></p>
              <p>ลองจิจูดที่เลือก: <span id="lng" class="font-bold text-blue-600">--</span></p>
              <!-- Moved Current Location Button here -->
              <button id="currentLocationButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ไปยังตำแหน่งปัจจุบัน
              </button>
            </div>

            <!-- Input field for employee ID -->
            <div class="w-full flex flex-col sm:flex-row items-center sm:space-x-4 mt-2">
              <label for="employeeIdInput" class="text-gray-700 text-lg font-medium sm:w-1/4">ID พนักงาน:</label>
              <input type="text" id="employeeIdInput" placeholder="เช่น 824001, 824002, 824003" 
                     class="mt-1 sm:mt-0 flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm text-gray-800">
            </div>

            <!-- Buttons for saving, clearing, and exporting locations -->
            <div id="normalActionButtons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4 w-full justify-center flex-wrap">
              <button id="saveButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                บันทึกตำแหน่งปัจจุบัน
              </button>
              <button id="clearAllButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                ล้างตำแหน่งที่บันทึกทั้งหมด
              </button>
              <button id="exportCsvButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Export เป็น CSV
              </button>
              <button id="undoButton" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition transform hover:scale-105">
                ย้อนกลับ
              </button>
            </div>

            <!-- New edit action buttons -->
            <div id="editActionButtons" class="flex space-x-4 mt-4 hidden">
              <button id="confirmEditButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition transform hover:scale-105">
                บันทึกการแก้ไข
              </button>
              <button id="cancelEditButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow-md transition transform hover:scale-105">
                ยกเลิก
              </button>
            </div>
        </div> <!-- End Panel Controls -->
    </div> <!-- End Sticky Header -->

    <!-- Message box for user feedback -->
    <div id="messageBox" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg hidden text-center w-full">
      <p id="messageText"></p>
    </div>

    <!-- Saved Locations Table -->
    <div class="w-full mt-8">
      <h4 class="text-xl font-semibold text-gray-800 mb-4 text-center">ตำแหน่งที่บันทึกไว้</h4>
      <div class="overflow-auto max-h-[300px] border border-gray-300 rounded-lg shadow-sm">
        <table class="min-w-full bg-white">
          <thead>
            <tr class="bg-gray-100 border-b border-gray-200">
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 rounded-tl-lg">ID</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">ID พนักงาน</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">ละติจูด</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">ลองจิจูด</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">เวลาที่บันทึก</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">ลิงก์ Google Maps</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 rounded-tr-lg">การดำเนินการ</th>
            </tr>
          </thead>
          <tbody id="savedLocationsTableBody">
            <!-- Rows will be dynamically inserted here -->
            <tr class="text-center">
              <td colspan="7" class="py-4 px-4 text-gray-500">ยังไม่มีตำแหน่งที่บันทึกไว้</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h4 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">ยืนยันการลบข้อมูล</h4>
      <p id="modalMessage" class="text-gray-700 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่งที่บันทึกไว้ทั้งหมด? การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
      <div class="flex justify-center space-x-4">
        <button id="confirmClearButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
          ยืนยันการล้าง
        </button>
        <button id="cancelClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
          ยกเลิก
        </button>
      </div>
    </div>
  </div>

  <!-- Leaflet JavaScript for map functionality -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map; // Global variable for the map instance
    var currentMarker = null; // Marker for the currently selected location (red, non-draggable by default)
    var permanentMarkers = L.layerGroup(); // Layer group to hold all saved location markers (blue)
    var permanentMarkersMap = {}; // Maps loc.id to L.Marker object for easy access/removal
    var currentLat = null; // Variable to store the current latitude
    var currentLng = null; // Variable to store the current longitude
    var savedLocations = []; // Array to store all saved location objects
    var nextId = 1; // Counter for unique IDs
    var editingId = null; // Global variable to track the ID of the location being edited
    var editingMarker = null; // Global variable for the draggable yellow marker used in edit mode
    let undoStack = []; // Array เก็บ snapshot ของ savedLocations

    // Variables for confirmation modal dynamic content
    var actionType = null; // 'clearAll' or 'deleteSingle'
    var pendingDeleteIndex = null; // Stores the index of the item to delete if actionType is 'deleteSingle'

    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const savedLocationsTableBody = document.getElementById('savedLocationsTableBody');
    const employeeIdInput = document.getElementById('employeeIdInput'); 
    const locationSearchInput = document.getElementById('locationSearchInput'); 
    const searchResultsContainer = document.getElementById('searchResultsContainer'); 

    // Confirmation Modal elements
    const confirmationModal = document.getElementById('confirmationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const confirmClearButton = document.getElementById('confirmClearButton'); // This button is now dynamic
    const cancelClearButton = document.getElementById('cancelClearButton');
    const backButton = document.getElementById('backButton'); 

    // Edit action buttons
    const confirmEditButton = document.getElementById('confirmEditButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const editActionButtonsDiv = document.getElementById('editActionButtons');
    const normalActionButtonsDiv = document.getElementById('normalActionButtons'); // Get the new div
    const undoButton = document.getElementById('undoButton');


    // Define a custom red icon for the current marker
    var redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Define a custom blue icon for permanent markers (default Leaflet icon is blue)
    var blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Define a custom yellow icon for the editing marker
    var yellowIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // --- Helper Functions ---
    function showMessage(message, type = 'info') {
      messageText.textContent = message;
      messageBox.classList.remove('hidden');
      messageBox.classList.remove('bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
      
      if (type === 'success') {
        messageBox.classList.add('bg-green-100', 'text-green-800');
      } else if (type === 'error') {
        messageBox.classList.add('bg-red-100', 'text-red-800');
      } else if (type === 'warning') {
        messageBox.classList.add('bg-yellow-100', 'text-yellow-800');
      } else {
        messageBox.classList.add('bg-blue-100', 'text-blue-800');
      }
      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 3000);
    }

    function showClearConfirmation() {
        confirmationModal.classList.remove('hidden');
    }

    function hideClearConfirmation() {
        confirmationModal.classList.add('hidden');
        // Reset modal content to default for "clear all" next time
        modalTitle.textContent = 'ยืนยันการลบข้อมูล';
        modalMessage.innerHTML = 'คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่งที่บันทึกไว้ทั้งหมด? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
        confirmClearButton.textContent = 'ยืนยันการล้าง';
    }

    // Function to update the red currentMarker's position and display
    function updateCurrentMarker(lat, lng, isDraggable = false) {
        if (!currentMarker) {
            currentMarker = L.marker([lat, lng], {icon: redIcon, draggable: isDraggable}).addTo(map);
            currentMarker.on('dragend', function(e) {
                const newLatLng = e.target.getLatLng();
                currentLat = newLatLng.lat;
                currentLng = newLatLng.lng;
                document.getElementById('lat').textContent = currentLat.toFixed(6);
                document.getElementById('lng').textContent = currentLng.toFixed(6);
            });
        } else {
            currentMarker.setLatLng([lat, lng]);
            currentMarker.options.draggable = isDraggable; // Update draggable option
            // Manually re-add/remove draggable class if icon is already rendered for visual update
            if (currentMarker._icon) {
                if (isDraggable) {
                    L.DomUtil.addClass(currentMarker._icon, 'leaflet-marker-draggable');
                } else {
                    L.DomUtil.removeClass(currentMarker._icon, 'leaflet-marker-draggable');
                }
            }
            currentMarker.addTo(map); 
        }
        currentLat = lat;
        currentLng = lng;
        document.getElementById('lat').textContent = lat.toFixed(6);
        document.getElementById('lng').textContent = lng.toFixed(6);
    }

    // Function to hide the red currentMarker and clear display
    function hideCurrentMarker() {
        if (currentMarker && map.hasLayer(currentMarker)) {
            map.removeLayer(currentMarker);
        }
        currentLat = null;
        currentLng = null;
        document.getElementById('lat').textContent = '--';
        document.getElementById('lng').textContent = '--';
    }

    // --- Core Logic Functions ---

    function performClearAllLocations() {
      // Before clearing, save current state for undo
      undoStack.push(JSON.stringify(savedLocations)); 

      localStorage.removeItem('allSavedLocations');
      localStorage.removeItem('nextId');
      savedLocations = [];
      nextId = 1;
      
      hideCurrentMarker(); 
      if (editingMarker) map.removeLayer(editingMarker); // Also remove editing marker if any
      editingMarker = null;
      editingId = null; // Clear editing state
      employeeIdInput.value = '';
      locationSearchInput.value = '';
      searchResultsContainer.innerHTML = '';
      searchResultsContainer.classList.add('hidden');
      map.setView([13.7563, 100.5018], 6);
      showMessage('ตำแหน่งที่บันทึกไว้ทั้งหมดถูกลบแล้ว!', 'success');
      renderPermanentMarkers(); 
      renderTable(); 
      hideClearConfirmation(); 
      normalActionButtonsDiv.classList.remove('hidden'); 
      editActionButtonsDiv.classList.add('hidden'); 
    }

    function renderPermanentMarkers() {
      permanentMarkers.clearLayers(); 
      permanentMarkersMap = {}; 

      savedLocations.forEach((loc, index) => {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        // Permanent markers use the default blue icon
        const marker = L.marker([loc.lat, loc.lng], {icon: blueIcon}) 
          .addTo(permanentMarkers)
          .bindPopup(`
            <b>ID:</b> ${loc.id}<br>
            <b>ID พนักงาน:</b> ${loc.name}<br>
            <b>ละติจูด:</b> ${loc.lat}<br>
            <b>ลองจิจูด:</b> ${loc.lng}<br>
            <b>บันทึกเมื่อ:</b> ${loc.timestamp}<br>
            <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                <a href="${googleMapsUrl}" target="_blank" style="background-color: #4285f4; color: white; padding: 4px 8px; border-radius: 4px; text-decoration: none; display: inline-block;">
                    ดูบน Google Maps
                </a>
                <button class="edit-pin-btn" data-id="${loc.id}" style="background-color: #ffc107; color: white; padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; margin-left: 5px;">
                    แก้ไข
                </button>
                <button class="delete-btn" data-id="${loc.id}" style="background-color: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; margin-left: 5px;">
                    ลบ
                </button>
            </div>
          `);
          // Store marker reference in map for easy access
          permanentMarkersMap[loc.id] = marker;

          // Attach click listener for buttons inside popup
          marker.on('popupopen', function() {
              const popupContent = marker.getPopup().getContent();
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = popupContent; // Parse HTML string to DOM
              
              // Event listener for Delete button in popup
              const deleteButton = tempDiv.querySelector('.delete-btn');
              if (deleteButton) {
                  deleteButton.onclick = (e) => {
                      e.stopPropagation(); 
                      deleteLocation(parseInt(deleteButton.dataset.id)); // Call deleteLocation with ID
                      map.closePopup(); 
                  };
              }

              // Event listener for Edit button in popup
              const editButton = tempDiv.querySelector('.edit-pin-btn');
              if (editButton) {
                  editButton.onclick = (e) => {
                      e.stopPropagation();
                      map.closePopup(); // Close the popup
                      editLocation(parseInt(editButton.dataset.id)); // Call editLocation
                  };
              }
              // Replace content of popup with the DOM element to attach events
              marker.getPopup().setContent(tempDiv);
          });
      });
      permanentMarkers.addTo(map); 
    }

    function renderTable() {
      savedLocationsTableBody.innerHTML = ''; 

      if (savedLocations.length === 0) {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = '<td colspan="7" class="py-4 px-4 text-gray-500 text-center">ยังไม่มีตำแหน่งที่บันทึกไว้</td>';
        savedLocationsTableBody.appendChild(noDataRow);
        return;
      }

      savedLocations.forEach((loc, index) => {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        const row = document.createElement('tr');
        row.classList.add('border-b', 'border-gray-200', 'last:border-b-0');
        row.innerHTML = `
          <td class="py-3 px-4 text-sm text-gray-800">${loc.id}</td>
          <td class="py-3 px-4 text-sm text-gray-800">${loc.name || '-'}</td>
          <td class="py-3 px-4 text-sm text-gray-800">${loc.lat.toFixed(6)}</td>
          <td class="py-3 px-4 text-sm text-gray-800">${loc.lng.toFixed(6)}</td>
          <td class="py-3 px-4 text-sm text-gray-800">${loc.timestamp}</td>
          <td class="py-3 px-4 text-sm text-gray-800">
            <a href="${googleMapsUrl}" target="_blank" class="text-blue-600 hover:underline">ดูบน Google Maps</a>
          </td>
          <td class="py-3 px-4 text-sm text-gray-800">
            <button onclick="editLocation(${loc.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md shadow-sm transition duration-300 ease-in-out transform hover:scale-105">
                แก้ไข
            </button>
            <button onclick="deleteLocation(${loc.id})" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md shadow-sm transition duration-300 ease-in-out transform hover:scale-105 ml-2">
                ลบ
            </button>
          </td>
        `;
        savedLocationsTableBody.appendChild(row);
      });
    }

    // New function to handle editing a location
    function editLocation(id) {
        const loc = savedLocations.find(l => l.id === id);
        if (!loc) return; // Exit if location not found

        // If another item was being edited, implicitly save/cancel it first
        if (editingId !== null && editingId !== id) {
            cancelEditButton.click(); // Trigger cancel to clean up previous edit state
        }
        
        editingId = id; // Set the global editingId

        // Remove the permanent marker from the map for the item being edited
        if (permanentMarkersMap[loc.id]) {
            permanentMarkers.removeLayer(permanentMarkersMap[loc.id]);
            delete permanentMarkersMap[loc.id];
        }

        // Create or update the editingMarker (yellow, draggable)
        if (!editingMarker) {
            editingMarker = L.marker([loc.lat, loc.lng], {icon: yellowIcon, draggable: true}).addTo(map);
            editingMarker.on('drag', function(e) { // Use 'drag' for real-time updates
                const pos = e.target.getLatLng();
                currentLat = pos.lat;
                currentLng = pos.lng;
                document.getElementById('lat').textContent = currentLat.toFixed(6);
                document.getElementById('lng').textContent = currentLng.toFixed(6);
            });
        } else {
            editingMarker.setLatLng([loc.lat, loc.lng]);
            editingMarker.options.draggable = true;
            if (editingMarker._icon) {
                 L.DomUtil.addClass(editingMarker._icon, 'leaflet-marker-draggable');
            }
            editingMarker.addTo(map); // Ensure it's on the map
        }

        map.setView([loc.lat, loc.lng], map.getZoom() || 14); // Zoom to the location

        // Populate input fields with current values
        employeeIdInput.value = loc.name;
        document.getElementById('lat').textContent = loc.lat.toFixed(6);
        document.getElementById('lng').textContent = loc.lng.toFixed(6);
        currentLat = loc.lat; // Set global currentLat/Lng to initial edit values
        currentLng = loc.lng;


        // Show "Save Edit" and "Cancel" buttons, hide normal action buttons
        editActionButtonsDiv.classList.remove('hidden');
        normalActionButtonsDiv.classList.add('hidden'); // Hide normal buttons

        showMessage(`กำลังแก้ไขตำแหน่ง ID: ${id}`, 'info');
    }

    function saveLocation() {
      // Before saving, push current state to undoStack
      undoStack.push(JSON.stringify(savedLocations));

      // If currently in edit mode, save the edit using confirmEditButton logic
      if (editingId !== null) {
          confirmEditButton.click(); // Trigger the click of confirm edit button
          return; // Exit saveLocation as edit is handled
      } 
      // Else, proceed with adding new location
      
      if (currentLat === null || currentLng === null) {
        showMessage('กรุณาคลิกบนแผนที่หรือค้นหาสถานที่ก่อนบันทึก!', 'warning');
        return;
      }

      let employeeId = employeeIdInput.value.trim();
      if (employeeId === '') {
        employeeId = `ID พนักงานที่ ${nextId}`;
      }

      const newLocation = {
        id: nextId,
        name: employeeId,
        lat: currentLat,
        lng: currentLng,
        timestamp: new Date().toLocaleString('th-TH')
      };
      savedLocations.push(newLocation);
      nextId++;
      showMessage('บันทึกตำแหน่งใหม่เรียบร้อย!', 'success');
      
      localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
      localStorage.setItem('nextId', nextId.toString());
      
      employeeIdInput.value = ''; // Clear input field
      hideCurrentMarker(); // Hide red marker
      renderPermanentMarkers(); // Re-render all blue markers
      renderTable(); // Re-render table
    }

    function loadLocations() {
      const storedLocations = localStorage.getItem('allSavedLocations');
      const storedNextId = localStorage.getItem('nextId');

      if (storedLocations) {
        savedLocations = JSON.parse(storedLocations);
        let maxId = 0;
        savedLocations.forEach(loc => {
          if (loc.id && typeof loc.id === 'number' && loc.id > maxId) {
            maxId = loc.id;
          }
          if (!loc.name || loc.name.startsWith('ตำแหน่งที่ ')) {
            loc.name = `ID พนักงานที่ ${loc.id || savedLocations.indexOf(loc) + 1}`;
          }
        });
        nextId = maxId + 1;
        showMessage('โหลดตำแหน่งที่บันทึกไว้แล้ว!', 'info');
      } else {
        savedLocations = [];
        showMessage('ไม่พบตำแหน่งที่บันทึกไว้', 'info');
      }
      
      if (storedNextId) {
        nextId = parseInt(storedNextId);
      } else if (savedLocations.length > 0) {
        const maxId = savedLocations.reduce((max, loc) => Math.max(max, loc.id || 0), 0);
        nextId = maxId + 1;
      } else {
        nextId = 1;
      }

      renderPermanentMarkers();
      renderTable();
    }

    function deleteLocation(id) { // Now accepts ID instead of index
      // Before deleting, push current state to undoStack
      undoStack.push(JSON.stringify(savedLocations));

      const index = savedLocations.findIndex(loc => loc.id === id);
      if (index === -1) {
        showMessage('ไม่พบรายการที่จะลบ', 'error');
        return;
      }

      // Store the intention and index for the confirmation
      actionType = 'deleteSingle';
      pendingDeleteIndex = index; // Store the actual index

      // Update modal content for single delete
      modalTitle.textContent = 'ยืนยันการลบตำแหน่ง';
      const locToDelete = savedLocations[index];
      modalMessage.innerHTML = `คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่ง <b>ID: ${locToDelete.id}</b> (พนักงาน: ${locToDelete.name})? การดำเนินการนี้ไม่สามารถย้อนกลับได้`;
      confirmClearButton.textContent = 'ยืนยันการลบ';

      showClearConfirmation();
    }

    function csvEscape(value) {
      if (value === null || value === undefined) {
        return '';
      }
      let stringValue = String(value);
      if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
        return `"${stringValue.replace(/"/g, '""')}"`;
      }
      return stringValue;
    }

    function exportToCSV() {
      if (savedLocations.length === 0) {
        showMessage('ไม่มีข้อมูลที่จะ Export!', 'warning');
        return;
      }

      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "ID,ID พนักงาน,ละติจูด,ลองจิจูด,เวลาที่บันทึก,ลิงก์ Google Maps\n";

      savedLocations.forEach(function(loc) {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
        
        let row = [
          csvEscape(loc.id),
          csvEscape(loc.name),
          csvEscape(loc.lat.toFixed(6)),
          csvEscape(loc.lng.toFixed(6)),
          csvEscape(loc.timestamp),
          csvEscape(googleMapsUrl)
        ].join(',');

        csvContent += row + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "saved_employee_locations.csv");
      document.body.appendChild(link);

      link.click();
      document.body.removeChild(link);

      showMessage('Export ข้อมูลเป็น CSV เรียบร้อยแล้ว!', 'success');
    }

    function getCurrentLocation() {
      // Implicitly cancel any ongoing edit before getting new location
      if (editingId !== null) {
          cancelEditButton.click(); 
      }

      if (navigator.geolocation) {
        showMessage('กำลังค้นหาตำแหน่งปัจจุบัน...', 'info');
        searchResultsContainer.innerHTML = '';
        searchResultsContainer.classList.add('hidden');
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = parseFloat(position.coords.latitude);
            const lng = parseFloat(position.coords.longitude);
            updateCurrentMarker(lat, lng, false); // Not draggable by default for new selections
            map.setView([lat, lng], 15);
            showMessage('พบตำแหน่งปัจจุบันแล้ว!', 'success');
          },
          (error) => {
            let errorMessage = '';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'ไม่อนุญาตให้เข้าถึงตำแหน่ง';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'ไม่สามารถระบุตำแหน่งได้';
                break;
              case error.TIMEOUT:
                errorMessage = 'หมดเวลาในการค้นหาตำแหน่ง';
                break;
              default:
                errorMessage = `เกิดข้อผิดพลาด: ${error.message}`;
                break;
            }
            showMessage(`ไม่สามารถระบุตำแหน่งปัจจุบันได้: ${errorMessage}`, 'error');
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      } else {
        showMessage('เบราว์เซอร์ของคุณไม่รองรับ Geolocation.', 'error');
      }
    }

    async function searchLocation(query) {
      if (!query) {
        searchResultsContainer.innerHTML = '';
        searchResultsContainer.classList.add('hidden');
        return;
      }

      // Implicitly cancel any ongoing edit before new search
      if (editingId !== null) {
          cancelEditButton.click(); 
      }

      searchResultsContainer.innerHTML = '';
      searchResultsContainer.classList.add('hidden');
      
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`); 
        const data = await response.json();

        if (data && data.length > 0) {
          data.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100', 'border-b', 'border-gray-200', 'last:border-b-0', 'text-gray-800');
            resultItem.textContent = result.display_name;
            resultItem.dataset.lat = result.lat;
            resultItem.dataset.lng = result.lon;

            resultItem.addEventListener('click', () => {
              const selectedLat = parseFloat(resultItem.dataset.lat);
              const selectedLng = parseFloat(resultItem.dataset.lng);
              updateCurrentMarker(selectedLat, selectedLng, false); // Update and show red marker (non-draggable)
              map.setView([selectedLat, selectedLng], 13);
              showMessage(`เลือกสถานที่: ${result.display_name}`, 'success');
              searchResultsContainer.classList.add('hidden');
              locationSearchInput.value = result.display_name;
            });
            searchResultsContainer.appendChild(resultItem);
          });
          searchResultsContainer.classList.remove('hidden');
        } else {
          // No direct message for "not found" to avoid spamming for autocomplete
        }
      } catch (error) {
        console.error('Error searching location:', error);
      }
    }

    // --- New Edit Action Button Event Listeners ---
    confirmEditButton.addEventListener('click', function() {
        // Before confirming edit, push current state to undoStack
        undoStack.push(JSON.stringify(savedLocations));

        if (editingId === null || currentLat === null || currentLng === null) {
            showMessage('ไม่มีการแก้ไขที่กำลังดำเนินการ หรือข้อมูลไม่สมบูรณ์', 'warning');
            return;
        }

        const locIndex = savedLocations.findIndex(l => l.id === editingId);
        if (locIndex === -1) {
            showMessage('ไม่พบตำแหน่งที่จะอัปเดต', 'error');
            cancelEditButton.click(); // Clean up state
            return;
        }

        const loc = savedLocations[locIndex];
        const newEmployeeId = employeeIdInput.value.trim();
        const newLat = currentLat;
        const newLng = currentLng;

        // Validation before saving
        if (newEmployeeId === '') {
            showMessage('ID พนักงานไม่สามารถเว้นว่างได้', 'error');
            return; // Prevent saving
        }
        if (isNaN(newLat) || newLat < -90 || newLat > 90 || isNaN(newLng) || newLng < -180 || newLng > 180) {
             showMessage('ค่าละติจูดและลองจิจูดไม่ถูกต้อง กรุณาแก้ไขให้ถูกต้อง', 'error');
             return; 
        }

        loc.lat = newLat;
        loc.lng = newLng;
        loc.name = newEmployeeId;
        loc.timestamp = new Date().toLocaleString('th-TH'); // Update timestamp on edit
        localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
        showMessage('อัปเดตตำแหน่งแล้ว!', 'success');

        // Clean up editing state
        editingId = null;
        if (editingMarker) map.removeLayer(editingMarker);
        editingMarker = null;
        currentLat = null;
        currentLng = null;
        document.getElementById('lat').textContent = '--';
        document.getElementById('lng').textContent = '--';
        employeeIdInput.value = '';
        editActionButtonsDiv.classList.add('hidden'); // Hide edit action buttons
        normalActionButtonsDiv.classList.remove('hidden'); // Show normal action buttons

        renderPermanentMarkers(); // Re-render all markers including the updated one
        renderTable(); // Re-render table to show updated data
    });

    cancelEditButton.addEventListener('click', function() {
        if (editingMarker) map.removeLayer(editingMarker); // Remove yellow marker
        editingMarker = null;
        editingId = null; // Clear editing state
        currentLat = null; // Clear current lat/lng
        currentLng = null;
        document.getElementById('lat').textContent = '--';
        document.getElementById('lng').textContent = '--';
        employeeIdInput.value = ''; // Clear employee ID input
        editActionButtonsDiv.classList.add('hidden'); // Hide edit action buttons
        normalActionButtonsDiv.classList.remove('hidden'); // Show normal action buttons
        showMessage('ยกเลิกการแก้ไขแล้ว', 'info');
        renderPermanentMarkers(); // Re-render permanent markers to show original blue one
    });

    // --- Undo Function ---
    function undoLastAction() {
      if (undoStack.length === 0) {
        showMessage('ไม่พบการเปลี่ยนแปลงก่อนหน้า', 'warning');
        return;
      }
      
      // Before undoing, clean up any active editing state
      if (editingId !== null) {
          cancelEditButton.click(); 
      }

      const lastState = undoStack.pop();
      if (lastState) {
        savedLocations = JSON.parse(lastState);
        localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
        renderPermanentMarkers();
        renderTable();
        showMessage('ย้อนกลับการเปลี่ยนแปลงแล้ว', 'success');
      }
    }


    // --- Initialization ---
    window.onload = function() {
      map = L.map('map').setView([13.7563, 100.5018], 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      permanentMarkers.addTo(map); // Add the layer group to the map

      // Updated map.on('click') logic
      map.on('click', function(e) {
        const lat = parseFloat(e.latlng.lat);
        const lng = parseFloat(e.latlng.lng);

        if (editingId !== null) {
          // If in edit mode, move the yellow editing marker to the new click location
          if (editingMarker) {
            editingMarker.setLatLng([lat, lng]);
          } else {
            // This case should ideally not be hit if editLocation is called correctly,
            // but as a fallback, create a draggable yellow marker if it doesn't exist
            editingMarker = L.marker([lat, lng], { icon: yellowIcon, draggable: true }).addTo(map);
            editingMarker.on('drag', function(dragE) { // Add drag listener for newly created marker
                const pos = dragE.target.getLatLng();
                currentLat = pos.lat;
                currentLng = pos.lng;
                document.getElementById('lat').textContent = currentLat.toFixed(6);
                document.getElementById('lng').textContent = currentLng.toFixed(6);
            });
          }
          currentLat = lat; // Update currentLat/Lng with new click position
          currentLng = lng;
          document.getElementById('lat').textContent = lat.toFixed(6);
          document.getElementById('lng').textContent = lng.toFixed(6);
        } else {
          // Normal mode (not editing), update the red currentMarker
          updateCurrentMarker(lat, lng, false); // New selections are not draggable
        }

        // Always hide search results when clicking on the map
        searchResultsContainer.innerHTML = '';
        searchResultsContainer.classList.add('hidden');
      });


      let searchTimeout;
      locationSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchLocation(e.target.value);
        }, 500); 
      });

      document.getElementById('searchLocationButton').addEventListener('click', () => {
        searchLocation(locationSearchInput.value);
      });

      document.getElementById('saveButton').addEventListener('click', saveLocation);
      document.getElementById('clearAllButton').addEventListener('click', function() { // Modified clearAllButton click
          actionType = 'clearAll';
          modalTitle.textContent = 'ยืนยันการลบข้อมูลทั้งหมด';
          modalMessage.innerHTML = 'คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่งที่บันทึกไว้ทั้งหมด? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
          confirmClearButton.textContent = 'ยืนยันการล้างทั้งหมด';
          showClearConfirmation();
      });
      document.getElementById('exportCsvButton').addEventListener('click', exportToCSV);
      document.getElementById('currentLocationButton').addEventListener('click', getCurrentLocation);
      
      // Global confirm/cancel for ALL modal actions
      confirmClearButton.addEventListener('click', function() {
        if (actionType === 'clearAll') {
            performClearAllLocations();
        } else if (actionType === 'deleteSingle') {
            if (pendingDeleteIndex !== null && savedLocations[pendingDeleteIndex]) {
                // Before single delete, push current state to undoStack
                undoStack.push(JSON.stringify(savedLocations));

                const deletedLoc = savedLocations.splice(pendingDeleteIndex, 1);
                localStorage.setItem('allSavedLocations', JSON.stringify(savedLocations));
                showMessage(`ลบตำแหน่ง (ID: ${deletedLoc[0].id}, ID พนักงาน: ${deletedLoc[0].name}) แล้ว!`, 'success');
                renderPermanentMarkers();
                renderTable();
                // If the deleted item was the one being edited, clean up edit state
                if (editingId === deletedLoc[0].id) { 
                    cancelEditButton.click(); // Trigger cancel to clean up
                }
            }
        }
        actionType = null; // Reset action type
        pendingDeleteIndex = null; // Clear pending index
        hideClearConfirmation(); // Hide modal and reset its content
      });

      cancelClearButton.addEventListener('click', function() {
        actionType = null; // Reset action type
        pendingDeleteIndex = null; // Clear pending index
        hideClearConfirmation(); // Hide modal and reset its content
        showMessage('ยกเลิกการดำเนินการแล้ว', 'info');
      });

      undoButton.addEventListener('click', undoLastAction); // Attach undo button listener


      backButton.addEventListener('click', () => {
        window.history.back();
      });

      loadLocations();

      map.invalidateSize();
    };

    // Adjust map size on window resize to ensure responsiveness
    window.addEventListener('resize', function() {
      if (map) {
        map.invalidateSize();
      }
    });
  </script>
</body>
</html>
